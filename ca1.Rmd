---
title: "Computer Assignment 1"
author: "Jan Alexandersson, Anton Stråhle & Max Sjödin"
date: "September 19, 2020"
output: pdf_document
---

```{r echo = FALSE, warning = FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(fitdistrplus))
```

```{r echo = FALSE, warning = FALSE}
n = 100
t0 <- rweibull(n, shape = 4.5, scale = 22.5)

#This is the relevant dataframe in the case of no ties and no censoring (t0, d0, y0)
no_ties <- as.data.frame(table(t0)) %>% 
  set_names(c("t0","d0")) %>% 
  mutate("y0" = cumsum(d0 %>%  rev()) %>% rev()) %>% 
  mutate(t0 = as.numeric(as.character(t0))) %>% 
  mutate(Ahat = cumsum(d0 / y0)) %>% 
  mutate(var = cumsum(1/(y0^2))) %>% 
  mutate(lower = Ahat*exp(-qnorm(0.95) * sqrt(var)/ Ahat)) %>% 
  mutate(upper = Ahat*exp(+qnorm(0.95) * sqrt(var)/ Ahat))

#Add 0.05 and round to closest decimal to bin the numbers correct
#This is the relevant dataframe in the case of ties and no censoring (t0, d0, y0)
with_ties <- round(t0 + 0.05, digits = 1) %>% 
  table() %>% 
  as.data.frame() %>% 
  set_names(c("t0","d0")) %>% 
  mutate("y0" = cumsum(d0 %>%  rev()) %>% rev()) %>% 
  mutate(t0 = as.numeric(as.character(t0))) %>% 
  mutate(Ahat = cumsum(d0 / y0))


################################################################
weibull_haz <- function(t, a, b){
  a/b *(t/b)^(a-1)
}

cum_weibull_haz <- function(t, a, b){
  (t/b)^a
}

seq <- seq(0,max(t0), max(t0)/n)

plot(no_ties$t0, no_ties$Ahat, type = "s", xlab = "t", ylab = "Cumulative hazard")
lines(no_ties$t0, no_ties$lower, type = "s", lty = "dashed")
lines(no_ties$t0, no_ties$upper, type = "s", lty = "dashed")
lines(with_ties$t0, with_ties$Ahat, type = "s", col = "red")
lines(seq, cum_weibull_haz(seq, 4.5,22.5), col = "green")
```

```{r echo = FALSE, warning = FALSE}
#This part includes censoring
c <- rexp(n, 1/80)
uncensored <- data.frame(t0 = t0) %>% 
  mutate(cens = as.numeric(c<t0)) %>%   
  mutate(t0_bin = round(t0 + 0.05, digits = 1)) %>% 
  arrange(t0) %>% 
  filter(cens == 0) 
  
with_censor <- uncensored$t0_bin %>% 
  table() %>% 
  as.data.frame() %>% 
  set_names(c("t0","d0")) %>% 
  mutate(t0 = as.numeric(as.character(t0)))

#Uses the time intervals for true events to include censoring, this is for computing y0
events_and_cens <- (t0 %>% cut(breaks = c(0,with_censor$t0)) %>% table() %>% as.data.frame())$Freq
y0 <- cumsum(events_and_cens %>%  rev()) %>% rev()


#This is the relevant dataframe in case of censoring (t0, d0, y0)
#Should work with or without ties
with_censor <- with_censor %>% 
  mutate(y0 = y0) %>% 
  mutate(Ahat = cumsum(d0 / y0)) %>% 
  mutate(var = cumsum(1/(y0^2))) %>% 
  mutate(lower = Ahat*exp(-qnorm(0.95) * sqrt(var)/ Ahat)) %>% 
  mutate(upper = Ahat*exp(+qnorm(0.95) * sqrt(var)/ Ahat))

plot(no_ties$t0, no_ties$Ahat, type = "s", xlab = "t", ylab = "Cumulative hazard")
#lines(with_ties$t0, with_ties$Ahat, type = "s", col = "red")
lines(with_censor$t0, with_censor$Ahat, type = "s", col = "blue")
lines(with_censor$t0, with_censor$lower, type = "s", lty = "dashed", col = "blue")
lines(with_censor$t0, with_censor$upper, type = "s", lty = "dashed", col = "blue")


#Fit weibull distr to uncensored data
fitW <- fitdist(uncensored$t0, "weibull", method = "mle", lower = c(0, 0))
dwei = dweibull(seq, shape=fitW$estimate["shape"], scale=fitW$estimate["scale"])


#hazard
plot(with_censor$t0, diff(c(0,with_censor$Ahat)), type = "s", col = "blue")
lines(seq, weibull_haz(seq, fitW$estimate["shape"], fitW$estimate["scale"]))

#cumulative hazard
plot(with_censor$t0, with_censor$Ahat, type = "s", col = "blue")
lines(seq, cum_weibull_haz(seq, fitW$estimate["shape"], fitW$estimate["scale"]))
```




