---
title: "Computer Assignment 1"
author: "Jan Alexandersson & Anton Str√•hle"
date: "September 1, 2020"
output: pdf_document
---

```{r echo = FALSE, warning = FALSE}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(fitdistrplus))
suppressPackageStartupMessages(library(MASS))
suppressPackageStartupMessages(library(actuar))
suppressPackageStartupMessages(library(gridExtra))
suppressPackageStartupMessages(library(eha))
```

```{r echo = FALSE, warning = FALSE}
n = 100
t0 <- rweibull(n, shape = 4.5, scale = 22.5)

#This is the relevant dataframe in the case of no ties and no censoring (t0, d0, y0)
no_ties <- as.data.frame(table(t0)) %>% 
  set_names(c("t0","d0")) %>% 
  mutate("y0" = cumsum(d0 %>%  rev()) %>% rev()) %>% 
  mutate(t0 = as.numeric(as.character(t0)))


#Add 0.05 and round to closest decimal to bin the numbers correct
#This is the relevant dataframe in the case of ties and no censoring (t0, d0, y0)
with_ties <- round(t0 + 0.05, digits = 1) %>% 
  table() %>% 
  as.data.frame() %>% 
  set_names(c("t0","d0")) %>% 
  mutate("y0" = cumsum(d0 %>%  rev()) %>% rev()) %>% 
  mutate(t0 = as.numeric(as.character(t0)))


plot(no_ties$t0, cumsum(no_ties$d0 / no_ties$y0), type = "s")
lines(with_ties$t0, cumsum(with_ties$d0 / with_ties$y0), type = "s", col = "red")

```

```{r echo = FALSE, warning = FALSE}
#This part includes censoring
c <- rexp(n, 1/80)
uncensored <- data.frame(t0 = t0) %>% 
  mutate(cens = as.numeric(c<t0)) %>%   
  mutate(t0_bin = round(t0 + 0.05, digits = 1)) %>% 
  arrange(t0) %>% 
  filter(cens == 0) 
  
with_censor <- uncensored$t0_bin %>% 
  table() %>% 
  as.data.frame() %>% 
  set_names(c("t0","d0")) %>% 
  mutate(t0 = as.numeric(as.character(t0)))

#Uses the time intervals for true events to include censoring, this is for computing y0
events_and_cens <- (t0 %>% cut(breaks = c(0,with_censor$t0)) %>% table() %>% as.data.frame())$Freq
y0 <- cumsum(events_and_cens %>%  rev()) %>% rev()


#This is the relevant dataframe in case of censoring (t0, d0, y0)
#Should work with or without ties
with_censor <- with_censor %>% mutate(y0 = y0)

plot(no_ties$t0, cumsum(no_ties$d0 / no_ties$y0), type = "s")
lines(with_ties$t0, cumsum(with_ties$d0 / with_ties$y0), type = "s", col = "red")
lines(with_censor$t0, cumsum(with_censor$d0 / with_censor$y0), type = "s", col = "blue")

```







```{r echo = FALSE, warning = FALSE, include = FALSE}
#https://rdrr.io/cran/mice/src/R/nelsonaalen.R
nelsonaalen <- function(data, timevar, statusvar) {
    #install.on.demand("survival")
    if (!is.data.frame(data)) 
        stop("Data must be a data frame")
    timevar <- as.character(substitute(timevar))
    statusvar <- as.character(substitute(statusvar))
    time <- data[, timevar]
    status <- data[, statusvar]
    
    hazard <- survival::basehaz(survival::coxph(survival::Surv(time, status) ~ 1))
    idx <- match(time, hazard[, "time"])
    return(hazard[idx, "hazard"])
}

n = 1000
time <- rweibull(n, shape = 4.5, scale = 22.5)
status <- rep(1, n)
df <- data.frame(time, status)

ch <- nelsonaalen(df, time, status)
est <- data.frame(time, ch) %>% rbind(0,0) %>%  arrange(time)


x <- seq(0,max(time), max(time)/n)
# plot(x, weibull_haz(x, 4.5,22.5), type="l", col="blue")
plot(x, eha::Hweibull(x, 4.5,22.5), type="l", col="blue")
lines(x = est$time, y = est$ch, type = 's')

#################################################
#with censored times
#something feels wrong here

c <- runif(n, 20, 30)
status_cens <- as.numeric(c <= time)
df_cens <- data.frame(time, status_cens)
ch_cens <- nelsonaalen(df_cens, time, status_cens)
est_cens <- data.frame(time, ch_cens) %>% rbind(0,0) %>%  arrange(time)
lines(x = est_cens$time, y = est_cens$ch_cens, type = 's')
##############################################
weibull_haz <- function(t, a, b){
  a/b *(t/b)^(a-1)
}
weibull_haz(x, 4.5,22.5)
############################################################
leuk$status <- 1  ## no censoring occurs in leuk data (MASS)
leuk
ch <- nelsonaalen(leuk, time, status)
plot(x = leuk$time, y = ch, ylab='Cumulative hazard', xlab='Time')

### See example on http://www.engineeredsoftware.com/lmar/pe_cum_hazard_function.htm
time <- c(43, 67, 92, 94, 149, rep(149,7))
status <- c(rep(1,5),rep(0,7))
eng <- data.frame(time, status)
ch <- nelsonaalen(eng, time, status)
plot(x = time, y = ch, ylab='Cumulative hazard', xlab='Time')
```

